<html>
    <head>
        <title>Negotiation Fun: {{ room }}</title>

	<style>

	  .clearfix {
	  overflow: auto;
	  }

	  .points {
	  color: #009933;
	  }

	  div#chat_container {
	  float:left;
	  width: 60%;
	  }

	  div#info_container {
	  margin-left: 62%;
	  }

	  textarea#chat {
	  width: 100%;
	  rows: 20;
	  cols: 200;
	  height: 50%;
	  }

	  input#text {
	  width: 100%;
	  }

#clockdiv{
    font-family: sans-serif;
    color: #fff;
    display: inline-block;
    font-weight: 100;
    text-align: center;
    font-size: 20px;
}

#clockdiv > div{
    padding: 7px;
    border-radius: 3px;
    background: #00BF96;
    display: inline-block;
}

#clockdiv div > span{
    padding: 10px;
    border-radius: 3px;
    background: #00816A;
    display: inline-block;
}

	</style>

        <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
        <script type="text/javascript" charset="utf-8">

			function handle_submission(data) {
			    if (data.success == 0) {
			        var ddlist = document.getElementById("restaurantsDDL");
			        var selected = ddlist.selectedIndex;
                    $.getJSON('/_validate', {outcome:selected}, handle_submission);
			    }
				else if (data.success == -1) {
				    jQuery.post('/_validate', {}, null);
					window.alert('You and your friend selected different restaurants. Please make sure you select the correct restaurant before submitting the form!')
					document.getElementById("wait").style.display = "none";
					document.getElementById("restaurantForm").style.display = "block";
					document.getElementById("submitform").style.display = "block";
				}
				else {
				window.alert('Congratulations! Your score for this game is:'+data.score);
				leave_room();
				}
            }
            
	        function onSubmit() {
	            jQuery.post('/_validate', {}, null);
	            var ddlist = document.getElementById("restaurantsDDL");
                var selected = ddlist.selectedIndex;
                document.getElementById("wait").style.display = "block";
                document.getElementById("restaurantForm").style.display = "none";
                document.getElementById("submitform").style.display = "none";
                $.getJSON('/_validate', {outcome:selected}, handle_submission);
                return false;
	        }
	        
            $(function() { 
            $("a#submitform").bind('click', onSubmit); 
            });
        </script>
        <script type="text/javascript" charset="utf-8">
            var socket;
            $(document).ready(function(){
                socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');
                socket.on('connect', function() {
                    socket.emit('joined', {});
                });
                socket.on('message', function(data) {
                    $('#chat').val($('#chat').val() + data.msg + '\n');
                    $('#chat').scrollTop($('#chat')[0].scrollHeight);
                });
                socket.on('endchat', function(data) {
                    alert(data['message']);
                    leave_room();
                });
               $('#text').keypress(function(e) {
                    var code = e.keyCode || e.which;
                    if (code == 13) {
                        text = $('#text').val();
                        $('#text').val('');
                        socket.emit('text', {msg: text});
                    }
                });
	       $('#btnPickRestaurant').click(function(e) {
                    socket.emit('pick', {restaurant: $('#ddRestaurants').val()});
                });
            });
            function leave_room() {
                socket.emit('left', {}, function() {
                    socket.disconnect();
                    window.location.href = "{{ url_for('main.index') }}";
                    return null;
                });
            }
            window.onbeforeunload = function(){
		        leave_room();
	        }
        </script>
        
        <script type="text/javascript" charset="utf-8">
					function getTimeRemaining(endtime) {
					  var t = Date.parse(endtime) - Date.parse(new Date());
					  var seconds = Math.floor((t / 1000) % 60);
					  var minutes = Math.floor((t / 1000 / 60));
					  return {
					    'total': t,
					    'minutes': minutes,
					    'seconds': seconds
					  };
					}

					function initializeClock(id, endtime) {
					  var clock = document.getElementById(id);
					  var minutesSpan = clock.querySelector('.minutes');
					  var secondsSpan = clock.querySelector('.seconds');

					  function updateClock() {
					    var t = getTimeRemaining(endtime);

					    minutesSpan.innerHTML = t.minutes;
					    secondsSpan.innerHTML = ('0' + t.seconds).slice(-2);

					    if (t.total <= 0) {
					      clearInterval(timeinterval);
					      alert("You and your friend have run out of time for this game! Redirecting you to the login page..");
					      leave_room();
					    }
					  }

					  updateClock();
					  var timeinterval = setInterval(updateClock, 1000);
					}


					function init() {
					  var deadline = new Date(Date.parse(new Date()) + {{ scenario_num_seconds }} * 1000);
					  initializeClock('clockdiv', deadline);
				        }
        </script>
    </head>
    <body onload='init()'>
      <div class="clearfix">
    <div id="chat_container">
        <h1>Where Should We Eat?</h1>
        <p>
            It's Friday night, and you and your friend, <b>{{partner}}</b> are trying to figure out where to eat dinner.
            You've discovered that there are {{scenario["restaurants"]|length}} restaurants nearby.
            You like some kinds of food better than others, and have a preferred price range in mind.
        </p>
	<ul>
	  <li> Use the chat box below to negotiate where to go for dinner. </li>
	  <li> Once you've <b>agreed on a restaurant</b>, select it from
            the drop down list on the right, and click 'Pick this restaurant!'.</li>
	</ul>

        <div id="clockdiv" align="right">
	  Time Remaining: 
	  <div>
	    <span class="minutes"></span>
	  </div>
	  <div>
	    <span class="seconds"></span>
	  </div>
	</div>

        <textarea id="chat"></textarea><br><br>
        <input id="text" placeholder="Enter your message here"><br><br>
        <a href="/">Leave this room</a>

    </div>

    <div id="info_container">
        <div id="preferences">

            <h3>Your cuisine preferences</h3>
            <ol class="cuisine_preferences_list">
	    {% for cuisine in agent["cuisine_func"] %}
            <li>{{cuisine[0]}} <span class="points"> ({{ cuisine[1] }} points) </span> </li>
            {% endfor %}
	    </ol>

            <h3>Your price range preferences</h3>
	    <ul>
	    {% for range,points in agent["spending_func"] %}
            <li> ${{ range[0] }} - ${{ range[1] }} <span class="points"> ({{ points }} points) </span> </li>
            {% endfor %}
	    </ul>

            <h3>Restaurants nearby</h3>
	    <ul>
            {% for restaurant in sorted_restaurants %}
            <li><b>{{ restaurant["name"] }}</b>: {{ restaurant["cuisine"]}}, ${{ restaurant["price_range"][0] }} - ${{ restaurant["price_range"][1] }}</li>
            {% endfor %}
	    </ul>
        </div>

        <form id="restaurantForm" method="POST">
        	<h3>Choose a restaurant below:</h3>
            <select id="ddRestaurants">
                {% set ctr = 0 %}
                {% for restaurant in scenario["restaurants"] %}
                <option value={{ctr}}>{{ restaurant["name"] }}</option>
                {% set ctr = ctr + 1 %}
                {% endfor %}
            </select>
        </form>
        <button type="button" id="btnPickRestaurant">Pick this restaurant!</button>
        <div id="wait" style="display:none">
            <h3>Please wait while we wait for your partner to submit a response...</h3>
        </div>

    </div>
    </div>
    </body>
</html>
