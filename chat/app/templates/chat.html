<html>
    <head>
        <title>Negotiation Fun: {{ room }}</title>
        <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
        <script type="text/javascript" charset="utf-8">
            var socket;
            $(document).ready(function(){
                socket = io.connect('http://' + document.domain + ':' + location.port + '/chat');
                socket.on('connect', function() {
                    socket.emit('joined', {});
                });
                socket.on('status', function(data) {
                    $('#chat').val($('#chat').val() + '<' + data.msg + '>\n');
                    $('#chat').scrollTop($('#chat')[0].scrollHeight);
                });
                socket.on('message', function(data) {
                    $('#chat').val($('#chat').val() + data.msg + '\n');
                    $('#chat').scrollTop($('#chat')[0].scrollHeight);
                });
                $('#text').keypress(function(e) {
                    var code = e.keyCode || e.which;
                    if (code == 13) {
                        text = $('#text').val();
                        $('#text').val('');
                        socket.emit('text', {msg: text});
                    }
                });
            });
            function leave_room() {
                socket.emit('left', {}, function() {
                    socket.disconnect();
		    return null;
                    // go back to the login page
                    window.location.href = "{{ url_for('main.index') }}";
                });
            }
            window.onbeforeunload = function(){
		leave_room();
	    }
        </script>
        <script type="text/javascript" charset="utf-8">
					function getTimeRemaining(endtime) {
					  var t = Date.parse(endtime) - Date.parse(new Date());
					  var seconds = Math.floor((t / 1000) % 60);
					  var minutes = Math.floor((t / 1000 / 60));
					  return {
					    'total': t,
					    'minutes': minutes,
					    'seconds': seconds
					  };
					}

					function initializeClock(id, endtime) {
					  var clock = document.getElementById(id);
					  var minutesSpan = clock.querySelector('.minutes');
					  var secondsSpan = clock.querySelector('.seconds');

					  function updateClock() {
					    var t = getTimeRemaining(endtime);

					    minutesSpan.innerHTML = t.minutes;
					    secondsSpan.innerHTML = ('0' + t.seconds).slice(-2);

					    if (t.total <= 0) {
					      clearInterval(timeinterval);
					    }
					  }

					  updateClock();
					  var timeinterval = setInterval(updateClock, 1000);
					}

					var deadline = new Date(Date.parse(new Date()) + {{ scenario.num_seconds }} * 1000);
					initializeClock('clockdiv', deadline);	  
        </script>
    </head>
    <body>
    <div id="chat_container", style="float:left; width:50%">
        <h1>Negotiation Fun</h1>
        <p>
            It's Friday night, and you and your friend are trying to figure out where to eat dinner. You've discovered that there are {{scenario["restaurants"]|length}} restaurants nearby. You like some kinds of food better than others, and have a preferred price range in mind. Use the chat box below to decide where to go for dinner!
        </p>

        <div id="clockdiv">
				  <div>
				    <span class="minutes"></span>
				    <div class="smalltext">Minutes</div>
				  </div>
				  <div>
				    <span class="seconds"></span>
				    <div class="smalltext">Seconds</div>
				  </div>
				</div>

        <textarea id="chat" cols="80" rows="20"></textarea><br><br>
        <input id="text" size="80" placeholder="Enter your message here"><br><br>
        <a href="/">Leave this room</a>
    </div>
    <div id="info_container", style="float:left; width:50%">
        <h3>Restaurants nearby</h3>
        {% for restaurant in scenario["restaurants"] %}
        <li><b>{{ restaurant[0] }}</b>: {{ restaurant[1]}}, ${{ restaurant[2][0] }} - ${{ restaurant[2][1] }}</li>
        {% endfor %}
        <h3>Your cuisine preferences</h3>
        {% for cuisine in scenario["agents"][agent_number - 1]["cuisine_func"] %}
        <li>{{cuisine[0]}}</li>
        {% endfor %}
        <h3>Your preferred price range</h3>
        {% set price_range = scenario["agents"][agent_number - 1]["spending_func"][0][0] %}
        <p>${{ price_range[0] }} - ${{price_range[1]}}</p>

        <form id="select_restaurant" method="POST">
            {{ form.hidden_tag() }}
            {{ form.restaurant_labels() }}
            {{ form.submit() }}
        </form>
        <!--<button id="submit">Submit</button>-->
    </div>
    </body>
</html>
